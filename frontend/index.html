<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Anon Chat</title>
</head>

<body>
    <h1>Anonymous Chat</h1>

    <div id="status">
        <p id="statusMessage"></p>
        <button id="startBtn" onclick="startChat()">Start Chat</button>
    </div>

    <div id="cooldownNotice" style="display:none; color:red; margin-bottom: 10px;">
        You're on cooldown. Please wait <span id="cooldownTimer"></span> seconds...
    </div>

    <div id="chat" style="display:none;">
        <div id="typing" style="font-style: italic; color: gray;"></div>
        <div id="messages" style="overflow-y: auto; max-height: 300px; border: 1px solid #ccc; padding: 8px;"></div>
        <input id="input" placeholder="Type..." />
        <button id="sendButton" onclick="sendMessage()">Send</button>
        <button onclick="leaveChat()">Leave Chat</button>
    </div>

    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
        const socket = io("http://localhost:3000", { autoConnect: false });

        let roomId = null;
        let chatting = false;
        let nickname = null;
        let partnerName = null;

        const input = document.getElementById("input");
        const sendButton = document.getElementById("sendButton");
        let typingTimeout;

        function startChat() {
            const startBtn = document.getElementById("startBtn");
            const statusMsg = document.getElementById("statusMessage");

            startBtn.disabled = true;
            startBtn.style.display = "none";

            statusMsg.innerText = "Waiting for a stranger...";
            if (!socket.connected) socket.connect();
            socket.emit("start-chat");
        }

        socket.on("waiting", () => {
            document.getElementById("statusMessage").innerText = "Waiting for a stranger...";
        });

        socket.on("matched", (data) => {
            roomId = data.roomId;
            nickname = data.nicknames[socket.id];
            partnerName = Object.values(data.nicknames).find(n => n !== nickname);

            input.focus();
            document.getElementById("status").style.display = "none";
            document.getElementById("chat").style.display = "block";
        });

        // Cooldown handling
        socket.on("chat-paused", (seconds) => {
            const notice = document.getElementById("cooldownNotice");
            const timer = document.getElementById("cooldownTimer");
            const startBtn = document.getElementById("startBtn");

            let remaining = seconds;
            notice.style.display = "block";
            timer.textContent = remaining;

            input.disabled = true;
            sendButton.disabled = true;
            startBtn.disabled = true;

            const interval = setInterval(() => {
                remaining--;
                timer.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(interval);
                    notice.style.display = "none";
                    input.disabled = false;
                    sendButton.disabled = false;
                    startBtn.disabled = false;
                    startBtn.style.display = "inline-block";
                }
            }, 1000);
        });

        input.addEventListener("input", () => {
            socket.emit("typing", roomId);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit("stop-typing", roomId);
            }, 1000);
        });

        socket.on("typing", () => {
            document.getElementById("typing").innerText = `${partnerName} is typing...`;
        });

        socket.on("stop-typing", () => {
            document.getElementById("typing").innerText = "";
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });

        socket.on("message", (msg) => {
            appendMessage(`${partnerName}: ${msg}`);
        });

        socket.on("idle-timeout", () => {
            alert("You were disconnected due to inactivity.");
        });

        socket.on("spam-warning", (msg) => {
            alert(msg);
        });

        socket.on("stranger-left", () => {
            endChat("Stranger has left the chat.");
        });

        function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;

            socket.emit("message", { roomId, message: msg });
            appendMessage(`${nickname}: ${msg}`);
            input.value = "";
        }

        function appendMessage(text) {
            const msgDiv = document.createElement("div");
            const now = new Date();
            const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            msgDiv.innerText = `[${timestamp}] ${text}`;

            const container = document.getElementById("messages");
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function leaveChat() {
            socket.emit("leave-room", roomId);
            endChat("You left the chat.");
        }

        function endChat(message) {
            chatting = false;
            roomId = null;

            document.getElementById("chat").style.display = "none";

            const statusDiv = document.getElementById("status");
            const statusMsg = document.getElementById("statusMessage");
            const startBtn = document.getElementById("startBtn");

            statusDiv.style.display = "block";
            statusMsg.innerText = message;

            startBtn.disabled = false;
            startBtn.style.display = "inline-block";

            document.getElementById("messages").innerHTML = "";
            document.getElementById("typing").innerText = "";
        }
    </script>
</body>

</html>